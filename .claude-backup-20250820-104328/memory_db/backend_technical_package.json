{
  "package_id": "backend_technical_package",
  "package_type": "migrated-context",
  "content": "{\n  \"package_type\": \"backend_technical\",\n  \"max_tokens\": 4000,\n  \"timestamp\": \"2025-08-15T21:15:00Z\",\n  \"priority\": \"CRITICAL\",\n  \n  \"authentication_architecture\": {\n    \"current_state\": {\n      \"router_fragmentation\": {\n        \"count\": 8,\n        \"locations\": [\n          \"app/api/routes/auth_routes.py\",\n          \"app/webui/routers/auth.py\",\n          \"app/webui/routers/oauth.py\",\n          \"app/webui/routers/auths.py\",\n          \"app/webui/apps/oauth/__init__.py\",\n          \"app/webui/apps/rag/main.py\",\n          \"app/webui/apps/retrieval/main.py\",\n          \"app/webui/main.py\"\n        ],\n        \"conflicts\": \"Multiple JWT implementations, inconsistent token formats\"\n      },\n      \"jwt_issues\": {\n        \"enhanced_format\": \"Uses 'id' claim with user_id string\",\n        \"standard_format\": \"Uses 'sub' claim with User object\",\n        \"token_expiry\": \"Inconsistent across routers (30min to 7days)\",\n        \"validation\": \"Different middleware in each router\"\n      }\n    },\n    \n    \"target_architecture\": {\n      \"unified_router\": \"app/api/routes/unified_auth.py\",\n      \"centralized_jwt\": \"app/core/auth/jwt_manager.py\",\n      \"session_manager\": \"app/core/auth/session_manager.py\",\n      \"middleware\": \"app/core/middleware/auth_middleware.py\"\n    },\n    \n    \"implementation_tasks\": [\n      {\n        \"task\": \"Create unified authentication router\",\n        \"location\": \"app/api/routes/unified_auth.py\",\n        \"endpoints\": [\"/login\", \"/logout\", \"/refresh\", \"/validate\", \"/session\"],\n        \"priority\": 1\n      },\n      {\n        \"task\": \"Centralize JWT token management\",\n        \"location\": \"app/core/auth/jwt_manager.py\",\n        \"requirements\": \"Single token format, consistent expiry, unified validation\",\n        \"priority\": 2\n      },\n      {\n        \"task\": \"Implement session-JWT bridge\",\n        \"location\": \"app/core/auth/session_manager.py\",\n        \"requirements\": \"Database sessions linked to JWT tokens\",\n        \"priority\": 3\n      },\n      {\n        \"task\": \"Create authentication middleware\",\n        \"location\": \"app/core/middleware/auth_middleware.py\",\n        \"requirements\": \"Single validation point for all routes\",\n        \"priority\": 4\n      }\n    ],\n    \n    \"critical_fixes\": {\n      \"jwt_format\": \"Standardize on 'sub' claim with user_id string\",\n      \"token_expiry\": \"Set consistent 30-minute access, 7-day refresh\",\n      \"logout_mechanism\": \"Implement token blacklist with Redis\",\n      \"websocket_auth\": \"Add header-based authentication support\"\n    }\n  },\n  \n  \"technical_specifications\": {\n    \"jwt_standard\": {\n      \"header\": {\"alg\": \"HS256\", \"typ\": \"JWT\"},\n      \"payload\": {\n        \"sub\": \"user_id_string\",\n        \"exp\": \"30_minutes\",\n        \"iat\": \"issued_at\",\n        \"jti\": \"unique_token_id\"\n      }\n    },\n    \"session_schema\": {\n      \"table\": \"user_sessions\",\n      \"fields\": [\"id\", \"user_id\", \"token_jti\", \"created_at\", \"expires_at\", \"is_active\"],\n      \"indexes\": [\"user_id\", \"token_jti\", \"expires_at\"]\n    },\n    \"redis_structure\": {\n      \"blacklist\": \"auth:blacklist:{jti}\",\n      \"session\": \"auth:session:{user_id}\",\n      \"ttl\": \"match_token_expiry\"\n    }\n  },\n  \n  \"dependencies\": {\n    \"internal\": [\"database_service\", \"redis_service\", \"user_service\"],\n    \"external\": [\"pyjwt\", \"passlib\", \"python-multipart\"],\n    \"coordination\": [\"frontend_auth_update\", \"database_migration\", \"security_validation\"]\n  },\n  \n  \"success_criteria\": {\n    \"functional\": [\n      \"Single authentication endpoint handles all auth flows\",\n      \"Consistent JWT format across all services\",\n      \"Logout invalidates tokens immediately\",\n      \"WebSocket authentication works with headers\"\n    ],\n    \"performance\": [\n      \"Login response < 100ms\",\n      \"Token validation < 10ms\",\n      \"Session lookup < 5ms\"\n    ],\n    \"security\": [\n      \"No debug endpoints exposed\",\n      \"CSRF protection enabled\",\n      \"Token blacklist functional\"\n    ]\n  }\n}",
  "tokens": 390,
  "created_at": "2025-08-18T15:14:25.582774",
  "last_accessed": "2025-08-18T15:14:25.582781",
  "priority": "medium",
  "context_tags": [
    "migrated",
    "context-package"
  ]
}