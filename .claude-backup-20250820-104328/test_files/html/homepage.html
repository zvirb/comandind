<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		
		<!-- PWA and Mobile Optimization Meta Tags -->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes, viewport-fit=cover" />
		<meta name="theme-color" content="#3b82f6" />
		<meta name="background-color" content="#ffffff" />
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="default" />
		<meta name="apple-mobile-web-app-title" content="AI Security" />
		<meta name="application-name" content="AI Security" />
		<meta name="msapplication-TileColor" content="#3b82f6" />
		<meta name="msapplication-config" content="/browserconfig.xml" />
		
		<!-- Security and Privacy -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="referrer" content="strict-origin-when-cross-origin" />
		<meta name="format-detection" content="telephone=no" />
		
		<!-- App Description -->
		<meta name="description" content="Secure multi-factor authentication and biometric access for AI Workflow Engine" />
		<meta name="keywords" content="authentication, security, biometric, 2FA, AI, workflow" />
		<meta name="author" content="AI Workflow Engine" />
		
		<!-- Favicon and Icons -->
		<link rel="icon" href="./favicon.png" />
		<link rel="apple-touch-icon" href="./icons/icon-192x192.png" />
		<link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192x192.png" />
		<link rel="mask-icon" href="./icons/maskable-icon-192x192.png" color="#3b82f6" />
		
		<!-- PWA Manifest -->
		<link rel="manifest" href="./manifest.json" />
		
		<!-- Preconnect to improve performance -->
		<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin />
		<link rel="dns-prefetch" href="https://fonts.googleapis.com" />
		
		<!-- Critical CSS inlining space -->
		<style>
			/* Critical mobile-first styles */
			* {
				box-sizing: border-box;
			}
			
			html, body {
				margin: 0;
				padding: 0;
				height: 100%;
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
			
			/* Touch optimizations */
			button, [role="button"] {
				touch-action: manipulation;
				min-height: 44px;
				min-width: 44px;
			}
			
			/* Scroll optimizations */
			.scrollable {
				-webkit-overflow-scrolling: touch;
				overscroll-behavior: contain;
			}
			
			/* Loading state */
			.app-loading {
				display: flex;
				align-items: center;
				justify-content: center;
				height: 100vh;
				background: #f8fafc;
			}
			
			.app-loading .spinner {
				width: 40px;
				height: 40px;
				border: 3px solid #e2e8f0;
				border-top: 3px solid #3b82f6;
				border-radius: 50%;
				animation: spin 1s linear infinite;
			}
			
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
			
			/* Accessibility */
			@media (prefers-reduced-motion: reduce) {
				* {
					animation-duration: 0.01ms !important;
					animation-iteration-count: 1 !important;
					transition-duration: 0.01ms !important;
				}
			}
			
			/* High contrast mode */
			@media (prefers-contrast: high) {
				* {
					border-width: 2px !important;
				}
			}
			
			/* Dark mode */
			@media (prefers-color-scheme: dark) {
				.app-loading {
					background: #1e293b;
					color: #f1f5f9;
				}
			}
			
			/* Safe area handling for notched devices */
			@supports (padding: max(0px)) {
				body {
					padding-top: env(safe-area-inset-top);
					padding-bottom: env(safe-area-inset-bottom);
					padding-left: env(safe-area-inset-left);
					padding-right: env(safe-area-inset-right);
				}
			}
		</style>
		
		
		<link href="./_app/immutable/assets/0.D2fE_1WD.css" rel="stylesheet">
		<link href="./_app/immutable/assets/categoryStore.uUlE5HPL.css" rel="stylesheet">
		<link href="./_app/immutable/assets/2.BGaZq7-D.css" rel="stylesheet">
	</head>
	<body data-sveltekit-preload-data="tap">
		<!-- Loading fallback for slow connections -->
		<div id="app-loading" class="app-loading">
			<div>
				<div class="spinner"></div>
				<p style="margin-top: 1rem; color: #64748b;">Loading secure authentication...</p>
			</div>
		</div>
		
		<div style="display: contents"><!--[--><!--[--><!----><div class="app-container svelte-1r3t2f8"><header class="header svelte-1r3t2f8"><div class="header-content svelte-1r3t2f8"><h1 class="svelte-1r3t2f8">AI Workflow Engine</h1></div> <nav class="header-nav svelte-1r3t2f8"><!--[!--><!--]--></nav></header> <!--[!--><!--]--><!----> <!--[!--><!--]--><!----> <!--[!--><!--]--> <!--[!--><!--]--> <!--[!--><main class="main-content svelte-1r3t2f8"><!----><!----><!--[--><div class="login-container svelte-1ihbaya"><div class="login-card svelte-1ihbaya"><h1 class="svelte-1ihbaya">Login</h1> <form><div class="form-group svelte-1ihbaya"><label for="email" class="svelte-1ihbaya">Email:</label> <input type="email" id="email" value="" required autocomplete="email" class="svelte-1ihbaya"/></div> <div class="form-group svelte-1ihbaya"><label for="password" class="svelte-1ihbaya">Password:</label> <input type="password" id="password" value="" required autocomplete="current-password" class="svelte-1ihbaya"/></div> <!--[!--><!--]--> <button type="submit" class="btn btn-primary"><!--[!-->Login<!--]--></button></form> <div class="register-link svelte-1ihbaya"><p class="svelte-1ihbaya">Don't have an account? <a href="/register" class="svelte-1ihbaya">Register here</a></p></div></div></div><!--]--><!----><!----></main><!--]--></div> <!--[!--><!--]--><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_1m29c0t = {
						base: new URL(".", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("./_app/immutable/entry/start.BUhBaUIk.js"),
						import("./_app/immutable/entry/app.0GhGASIE.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2],
							data: [{type:"data",data:{user:null},uses:{}},{type:"data",data:null,uses:{}}],
							form: null,
							error: null
						});
					});

					if ('serviceWorker' in navigator) {
						addEventListener('load', function () {
							navigator.serviceWorker.register('./service-worker.js');
						});
					}
				}
			</script>
		</div>
		
		<!-- Enhanced Service Worker Registration with SSL Resilience -->
		<script>
			// Global app state for resilience tracking
			window.appState = window.appState || {
				serviceWorkerEnabled: false,
				sslIssueDetected: false,
				gracefulDegradationActive: false,
				errorRecoveryAttempts: 0,
				certificateWarningDismissed: false
			};
			
			// Remove loading screen when app loads
			window.addEventListener('DOMContentLoaded', () => {
				const loading = document.getElementById('app-loading');
				if (loading) {
					setTimeout(() => {
						loading.style.opacity = '0';
						setTimeout(() => loading.remove(), 300);
					}, 500);
				}
			});
			
			// Enhanced ServiceWorker registration with comprehensive error handling
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', () => {
					// Comprehensive secure context validation
					const isSecureContext = window.isSecureContext || 
											location.protocol === 'https:' || 
											location.hostname === 'localhost' || 
											location.hostname === '127.0.0.1';
					
					if (!isSecureContext) {
						console.warn('[SW] ServiceWorker registration skipped: Not in secure context');
						console.info('[SW] Required: HTTPS, localhost, or 127.0.0.1');
						
						// Show notification for non-localhost environments
						if (!['localhost', '127.0.0.1'].includes(location.hostname)) {
							showSSLNotification('HTTPS Required');
						}
						
						enableGracefulDegradation('non-secure-context');
						return;
					}
					
					// Attempt ServiceWorker registration with timeout and retry logic
					attemptServiceWorkerRegistration(0);
				});
			} else {
				console.warn('[SW] ServiceWorker not supported in this browser');
				enableGracefulDegradation('unsupported-browser');
			}
			
			// ServiceWorker registration with retry logic
			function attemptServiceWorkerRegistration(attemptCount) {
				const maxAttempts = 3;
				const timeout = 10000; // 10 second timeout
				
				console.log(`[SW] Registration attempt ${attemptCount + 1}/${maxAttempts}`);
				
				// Create registration promise with timeout
				const registrationPromise = navigator.serviceWorker.register('/service-worker.js');
				const timeoutPromise = new Promise((_, reject) => {
					setTimeout(() => reject(new Error('ServiceWorker registration timeout')), timeout);
				});
				
				Promise.race([registrationPromise, timeoutPromise])
					.then(registration => {
						console.log('[SW] Registered successfully:', registration);
						window.appState.serviceWorkerEnabled = true;
						
						// Setup update handling
						setupServiceWorkerUpdateHandling(registration);
						
						// Clear any previous SSL issue flags
						window.appState.sslIssueDetected = false;
						
						// Notify successful registration
						window.dispatchEvent(new CustomEvent('sw-registration-success', { 
							detail: { registration, attempt: attemptCount + 1 } 
						}));
						
					})
					.catch(error => {
						console.error(`[SW] Registration attempt ${attemptCount + 1} failed:`, error);
						
						// Categorize the error
						const errorCategory = categorizeServiceWorkerError(error);
						console.log(`[SW] Error category: ${errorCategory}`);
						
						// Handle SSL-specific errors without blocking app
						if (errorCategory === 'ssl-certificate') {
							window.appState.sslIssueDetected = true;
							showSSLErrorNotification(error.message);
						}
						
						// Retry logic for recoverable errors
						if (attemptCount < maxAttempts - 1 && isRetryableError(errorCategory)) {
							const retryDelay = Math.pow(2, attemptCount) * 1000; // Exponential backoff
							console.log(`[SW] Retrying in ${retryDelay}ms...`);
							
							setTimeout(() => {
								attemptServiceWorkerRegistration(attemptCount + 1);
							}, retryDelay);
							
						} else {
							// Final failure - enable graceful degradation
							console.warn('[SW] All registration attempts failed, enabling graceful degradation');
							enableGracefulDegradation(errorCategory, error);
							
							// Dispatch failure event
							window.dispatchEvent(new CustomEvent('sw-registration-failed', { 
								detail: { error, category: errorCategory, attempts: attemptCount + 1 } 
							}));
						}
					});
			}
			
			// Categorize ServiceWorker registration errors
			function categorizeServiceWorkerError(error) {
				const message = error.message?.toLowerCase() || '';
				
				if (message.includes('certificate') || 
					message.includes('ssl') || 
					message.includes('tls') ||
					message.includes('handshake')) {
					return 'ssl-certificate';
				}
				
				if (message.includes('timeout') || 
					message.includes('network') ||
					message.includes('fetch')) {
					return 'network-timeout';
				}
				
				if (message.includes('secure context') || 
					message.includes('https')) {
					return 'secure-context';
				}
				
				if (message.includes('script') || 
					message.includes('syntax') ||
					message.includes('import')) {
					return 'script-error';
				}
				
				return 'unknown';
			}
			
			// Determine if error is retryable
			function isRetryableError(errorCategory) {
				return ['network-timeout', 'unknown'].includes(errorCategory);
			}
			
			// Setup ServiceWorker update handling
			function setupServiceWorkerUpdateHandling(registration) {
				registration.addEventListener('updatefound', () => {
					const newWorker = registration.installing;
					console.log('[SW] Update found, new worker installing');
					
					newWorker.addEventListener('statechange', () => {
						if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
							console.log('[SW] New version available');
							showUpdateNotification();
						}
					});
				});
			}
			
			// Show update notification with better UX
			function showUpdateNotification() {
				const notification = createNotificationElement(
					'🔄 Update Available',
					'A new version of the app is available. Refresh to update?',
					'#3b82f6',
					[
						{
							text: 'Update Now',
							action: () => window.location.reload(),
							primary: true
						},
						{
							text: 'Later',
							action: (notification) => notification.remove()
						}
					]
				);
				
				document.body.appendChild(notification);
			}
			
			// PWA install prompt handling
			let deferredPrompt;
			window.addEventListener('beforeinstallprompt', (e) => {
				e.preventDefault();
				deferredPrompt = e;
				
				// Show install banner after 30 seconds if not dismissed
				setTimeout(() => {
					if (deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
						const banner = document.createElement('div');
						banner.style.cssText = `
							position: fixed;
							top: 0;
							left: 0;
							right: 0;
							background: #3b82f6;
							color: white;
							padding: 12px 16px;
							text-align: center;
							z-index: 10000;
							font-size: 14px;
						`;
						banner.innerHTML = `
							<span>Install this app for better performance and offline access</span>
							<button onclick="this.parentElement.style.display='none'" style="background: none; border: none; color: white; margin-left: 16px; font-size: 18px;">×</button>
						`;
						
						banner.addEventListener('click', async () => {
							if (deferredPrompt) {
								deferredPrompt.prompt();
								const { outcome } = await deferredPrompt.userChoice;
								deferredPrompt = null;
								banner.remove();
							}
						});
						
						document.body.appendChild(banner);
						
						// Auto-hide after 10 seconds
						setTimeout(() => banner.remove(), 10000);
					}
				}, 30000);
			});
			
			// Performance monitoring
			window.addEventListener('load', () => {
				// Measure and log performance metrics
				setTimeout(() => {
					const navigation = performance.getEntriesByType('navigation')[0];
					const paint = performance.getEntriesByType('paint');
					
					const metrics = {
						loadTime: navigation.loadEventEnd - navigation.fetchStart,
						domContentLoaded: navigation.domContentLoadedEventEnd - navigation.fetchStart,
						firstPaint: paint.find(p => p.name === 'first-paint')?.startTime || 0,
						firstContentfulPaint: paint.find(p => p.name === 'first-contentful-paint')?.startTime || 0
					};
					
					console.log('[Performance] Page load metrics:', metrics);
					
					// Send to analytics if needed
					if (metrics.loadTime > 3000) {
						console.warn('[Performance] Slow page load detected:', metrics.loadTime + 'ms');
					}
				}, 0);
			});
			
			// Enhanced notification system with better UX
			function createNotificationElement(title, message, color, actions = []) {
				const notification = document.createElement('div');
				notification.style.cssText = `
					position: fixed;
					top: 16px;
					right: 16px;
					max-width: 400px;
					background: white;
					color: #1f2937;
					border-radius: 8px;
					box-shadow: 0 10px 25px rgba(0,0,0,0.2);
					border-left: 4px solid ${color};
					z-index: 10001;
					font-size: 14px;
					animation: slideInRight 0.3s ease-out;
					overflow: hidden;
				`;
				
				let actionsHtml = '';
				if (actions.length > 0) {
					actionsHtml = `
						<div style="display: flex; gap: 8px; margin-top: 12px;">
							${actions.map(action => `
								<button onclick="handleNotificationAction(this, '${action.text}')" 
									style="
										background: ${action.primary ? color : 'transparent'};
										color: ${action.primary ? 'white' : color};
										border: 1px solid ${color};
										padding: 6px 12px;
										border-radius: 4px;
										cursor: pointer;
										font-size: 12px;
										font-weight: 500;
									">
									${action.text}
								</button>
							`).join('')}
						</div>
					`;
				}
				
				notification.innerHTML = `
					<div style="padding: 16px;">
						<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
							<strong style="color: ${color};">${title}</strong>
							<button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
								style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 18px; line-height: 1;">
								×
							</button>
						</div>
						<div style="color: #6b7280; line-height: 1.4;">${message}</div>
						${actionsHtml}
					</div>
				`;
				
				// Store actions for reference
				notification._actions = actions;
				
				// Auto-remove after 10 seconds unless it has actions
				if (actions.length === 0) {
					setTimeout(() => {
						if (notification.parentNode) {
							notification.style.animation = 'slideOutRight 0.3s ease-in';
							setTimeout(() => notification.remove(), 300);
						}
					}, 10000);
				}
				
				return notification;
			}
			
			// Handle notification actions
			window.handleNotificationAction = function(button, actionText) {
				const notification = button.closest('div[style*="position: fixed"]');
				const actions = notification._actions || [];
				const action = actions.find(a => a.text === actionText);
				
				if (action && action.action) {
					action.action(notification);
				}
			};
			
			// Add animation styles
			const animationStyles = document.createElement('style');
			animationStyles.textContent = `
				@keyframes slideInRight {
					from { transform: translateX(100%); opacity: 0; }
					to { transform: translateX(0); opacity: 1; }
				}
				@keyframes slideOutRight {
					from { transform: translateX(0); opacity: 1; }
					to { transform: translateX(100%); opacity: 0; }
				}
			`;
			document.head.appendChild(animationStyles);
			
			// SSL Notification Functions with Enhanced UX
			function showSSLNotification(reason = 'HTTPS Required') {
				// Don't show if already dismissed in this session
				if (window.appState.certificateWarningDismissed) return;
				
				const notification = createNotificationElement(
					'⚠️ SSL Certificate Notice',
					`${reason}: The application will run with limited functionality. ServiceWorker and PWA features are disabled.`,
					'#f59e0b',
					[
						{
							text: 'I Understand',
							action: (notification) => {
								window.appState.certificateWarningDismissed = true;
								notification.remove();
							},
							primary: true
						}
					]
				);
				
				document.body.appendChild(notification);
			}
			
			function showSSLErrorNotification(errorMessage) {
				// Don't spam notifications
				if (window.appState.sslIssueDetected && 
					document.querySelector('[data-ssl-error-notification]')) {
					return;
				}
				
				const notification = createNotificationElement(
					'🔒 SSL Certificate Issue',
					`ServiceWorker registration failed due to certificate issues. The application will continue with basic functionality. Click "Details" to see the full error.`,
					'#ef4444',
					[
						{
							text: 'Details',
							action: () => {
								console.error('[SSL Error Details]', errorMessage);
								alert(`SSL Error Details:\n\n${errorMessage}\n\nThe application will continue to work, but some features like offline support and push notifications will be unavailable.`);
							}
						},
						{
							text: 'OK',
							action: (notification) => notification.remove(),
							primary: true
						}
					]
				);
				
				notification.setAttribute('data-ssl-error-notification', 'true');
				document.body.appendChild(notification);
			}
			
			// Enhanced graceful degradation with better user communication
			function enableGracefulDegradation(reason = 'unknown', error = null) {
				// Prevent multiple calls
				if (window.appState.gracefulDegradationActive) return;
				
				console.log(`[App] Enabling graceful degradation. Reason: ${reason}`);
				
				// Mark the app as running without ServiceWorker
				document.body.classList.add('no-service-worker');
				window.appState.gracefulDegradationActive = true;
				window.appState.serviceWorkerEnabled = false;
				
				// Disable PWA features that require ServiceWorker
				const pwaBanner = document.querySelector('[data-pwa-banner]');
				if (pwaBanner) {
					pwaBanner.style.display = 'none';
				}
				
				// Add visual indicator and styling adjustments
				const style = document.createElement('style');
				style.textContent = `
					.no-service-worker .pwa-only {
						display: none !important;
					}
					.no-service-worker .offline-indicator {
						opacity: 0.5;
					}
					.no-service-worker .sw-dependent {
						opacity: 0.7;
						pointer-events: none;
					}
					.no-service-worker::before {
						content: '';
						position: fixed;
						top: 0;
						left: 0;
						right: 0;
						height: 2px;
						background: linear-gradient(90deg, #f59e0b, #d97706);
						z-index: 9999;
						pointer-events: none;
					}
					
					/* Visual indicator for degraded mode */
					.no-service-worker .degraded-mode-indicator {
						position: fixed;
						bottom: 16px;
						left: 16px;
						background: rgba(245, 158, 11, 0.9);
						color: white;
						padding: 8px 12px;
						border-radius: 6px;
						font-size: 12px;
						z-index: 9998;
						backdrop-filter: blur(4px);
					}
				`;
				document.head.appendChild(style);
				
				// Add degraded mode indicator
				const indicator = document.createElement('div');
				indicator.className = 'degraded-mode-indicator';
				indicator.innerHTML = '⚠️ Limited Mode';
				indicator.title = 'ServiceWorker unavailable - some features may be limited';
				document.body.appendChild(indicator);
				
				// Auto-hide indicator after 10 seconds
				setTimeout(() => {
					if (indicator.parentNode) {
						indicator.style.opacity = '0';
						setTimeout(() => indicator.remove(), 300);
					}
				}, 10000);
				
				console.log('[App] Graceful degradation enabled - app will run with basic functionality');
				
				// Dispatch event for other parts of the app to respond to
				window.dispatchEvent(new CustomEvent('app-degraded-mode', { 
					detail: { reason, error } 
				}));
			}
			
			// Handle network status changes
			window.addEventListener('online', () => {
				console.log('[Network] Connection restored');
				document.body.classList.remove('offline');
			});
			
			window.addEventListener('offline', () => {
				console.log('[Network] Connection lost');
				document.body.classList.add('offline');
			});
		</script>
	</body>
</html>
