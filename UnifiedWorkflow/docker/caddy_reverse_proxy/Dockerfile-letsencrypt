# ==============================================================================
# Enhanced Caddy with Let's Encrypt DNS Plugins
# AI Workflow Engine - SSL Certificate Gateway
# ==============================================================================

FROM caddy:2-builder AS builder

# Build Caddy with Cloudflare DNS plugin only (most stable)
RUN xcaddy build \
    --with github.com/caddy-dns/cloudflare

FROM caddy:2-alpine

# Copy the custom built Caddy with DNS plugins
COPY --from=builder /usr/bin/caddy /usr/bin/caddy

# Install additional utilities for diagnostics
RUN apk add --no-cache su-exec curl jq openssl bind-tools

# Create the certificate directory structure
RUN mkdir -p /etc/certs /var/log/caddy

# Copy the entrypoint wrapper script
COPY docker/caddy_reverse_proxy/entrypoint-wrapper-letsencrypt.sh /usr/local/bin/entrypoint-wrapper.sh
RUN chmod +x /usr/local/bin/entrypoint-wrapper.sh

# Set the entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint-wrapper.sh"]

# Default command
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]

# Health check endpoint
HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=60s \
    CMD curl -f http://127.0.0.1:2019/config/ || exit 1

# Expose standard HTTP/HTTPS ports and admin API
EXPOSE 80 443 2019

# Add labels for service identification
LABEL service="caddy_letsencrypt"
LABEL component="ssl_gateway"
LABEL dns_providers="cloudflare"
LABEL version="2.0-dns"