# config/postgres/pg_hba.conf
# This configuration enforces end-to-end, mutually-authenticated TLS.

# TYPE  DATABASE        USER            ADDRESS                 METHOD
# Require all remote connections (IPv4 and IPv6) to use SSL and present a valid
# client certificate that is verified against the server's CA.
# The 'verify-ca' option correctly requires a client cert signed by our CA,
# which is compatible with modern PostgreSQL versions.
hostssl all             all             0.0.0.0/0               scram-sha-256 clientcert=verify-ca
hostssl all             all             ::/0                    scram-sha-256 clientcert=verify-ca

# Use 'peer' authentication for local (Unix socket) connections. This is the
# secure default, but fails when init scripts run as the 'postgres' OS user but
# need to connect as the 'app_user' DB user. Changing to scram-sha-256 allows
# password-based authentication for local connections, which the official
# postgres entrypoint script supports via POSTGRES_PASSWORD.
local   all             all                                     scram-sha-256