[databases]
; Per architectural documents, we define two distinct pools.
; 'app_tx' uses transaction pooling for scalable, stateless services (FastAPI, Celery).
app_tx = host=${POSTGRES_HOST} port=5432 dbname=ai_workflow_db pool_mode=transaction

; 'app_session' uses session pooling for stateful tasks (e.g., long-running Celery jobs).
app_session = host=${POSTGRES_HOST} port=5432 dbname=ai_workflow_db pool_mode=session

; Direct database access for API authentication
ai_workflow_db = host=${POSTGRES_HOST} port=5432 dbname=ai_workflow_db pool_mode=transaction

[pgbouncer]
; Administrative settings
listen_addr = 0.0.0.0
listen_port = 6432
auth_type = scram-sha-256
; The auth_file path is hardcoded. The entrypoint wrapper script generates this file.
auth_file = /etc/pgbouncer/generated/pgbouncer_users_processed
pidfile = /tmp/pgbouncer.pid
; The healthcheck connects as 'app_user', so it must be an admin user.
; 'pgbouncer' is kept for consistency with documentation on auth_query users.
admin_users = pgbouncer, app_user

; --- Client-Facing SSL Configuration ---
; SSL encryption required with server certificates for client connections
client_tls_sslmode = require
client_tls_cert_file = /etc/pgbouncer/certs/unified-cert.pem
client_tls_key_file = /etc/pgbouncer/certs/unified-key.pem
client_tls_ca_file = /etc/pgbouncer/certs/rootCA.pem

; --- Server-Facing SSL Configuration ---
server_tls_sslmode = require
server_tls_ca_file = /etc/pgbouncer/certs/rootCA.pem

; === OPTIMIZED CONNECTION POOL SETTINGS FOR 400+ CONCURRENT CONNECTIONS ===
; Pool settings are optimized for high-throughput production workloads.
; The pool_mode is defined per-database to support both transaction and session pooling.

; Transaction Pool Configuration (for FastAPI, short-lived operations)
; Increased from 30
default_pool_size = 80
; Increased from 250
max_client_conn = 600
; Increased from 10
reserve_pool_size = 30
; Reduced from 5
reserve_pool_timeout = 3

; Session Pool Configuration  
; Increased from 50
max_db_connections = 100
pool_mode = transaction

; === CONNECTION TIMEOUT AND LIFECYCLE SETTINGS ===
; Optimized for high-concurrency scenarios with proper cleanup
; Reduced from 15
server_connect_timeout = 10
; Reduced from 3
server_login_retry = 2
; Reduced from 120
query_timeout = 60
; Reduced from 30
query_wait_timeout = 15
; Reduced from 60
client_login_timeout = 45
; Reduced from 3600
autodb_idle_timeout = 1800
; Reduced from 3600
server_lifetime = 1800
; Reduced from 600
server_idle_timeout = 600
client_idle_timeout = 0

; === CONNECTION HEALTH AND MONITORING ===
; Enable connection health checks and monitoring for production reliability
; Reduced from 30
server_check_delay = 10
server_check_query = SELECT 1
server_fast_close = 1
tcp_keepalive = 1
tcp_keepcnt = 5
; Reduced from 600
tcp_keepidle = 600
; Reduced from 30
tcp_keepintvl = 10

; === PERFORMANCE TUNING ===
; Optimized for high throughput and low latency
; Increased from 4096
listen_backlog = 12288
; Increased from 5
sbuf_loopcnt = 10
so_reuseport = 1
tcp_defer_accept = 1

; === LOGGING AND DEBUGGING ===
; Production-level logging with performance monitoring
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
; Reduced from 60
stats_period = 30
verbose = 0

; === CONNECTION HYGIENE ===
; Parameters to ignore for better compatibility
ignore_startup_parameters = extra_float_digits,search_path
